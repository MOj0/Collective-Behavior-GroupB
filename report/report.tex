\documentclass[9pt]{pnas-new}
% Use the lineno option to display guide line numbers if required.
% Note that the use of elements such as single-column equations
% may affect the guide line number alignment. 

% \RequirePackage[english,slovene]{babel} % when writing in slovene
\RequirePackage[slovene,english]{babel} % when writing in english

% Custom added packages
\usetikzlibrary{shapes.geometric}

\templatetype{pnasresearcharticle} % Choose template 
% {pnasresearcharticle} = Template for a two-column research article
% {pnasmathematics} = Template for a one-column mathematics article
% {pnasinvited} = Template for a PNAS invited submission

\selectlanguage{english}
%\etal{in sod.} % comment out when writing in english
%\renewcommand{\Authands}{ in } % comment out when writing in english
%\renewcommand{\Authand}{ in } % comment out when writing in english

\newcommand{\set}[1]{\ensuremath{\mathbf{#1}}}
\renewcommand{\vec}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\uvec}[1]{\ensuremath{\hat{\vec{#1}}}}
\newcommand{\const}[1]{{\ensuremath{\kappa_\mathrm{#1}}}} 

\newcommand{\num}[1]{#1}

\graphicspath{{./fig/}}

\title{Predator-Prey Simulation Using Boids Model}

% Use letters for affiliations, numbers to show equal authorship (if applicable) and to indicate the corresponding author
\author{Matija Ojo}
\author{Miha Krajnc}
\author{Marko Adžaga}
\author{Janez Kuhar}

\affil{Collective behavior course research seminar report}

% Please give the surname of the lead author for the running footer
\leadauthor{Ojo} 

\selectlanguage{english}

% Please add here a significance statement to explain the relevance of your work
\significancestatement{Collective behavior course research seminar report}{Predator-prey interactions is of significant importance in biology and nature itself. The insights gleaned from this research can offer more than a theoretical understanding; they pave the way for the design and optimization of autonomous agents capable of adaptive and context-aware behaviors. The applications range from research in biology to simulations of large amounts of boids found in computer graphics.}{Collective behavior | Boids | Simulation | Prey-Predator | Escape patterns}

\selectlanguage{english}

% Please include corresponding author, author contribution and author declaration information
%\authorcontributions{Please provide details of author contributions here.}
%\authordeclaration{Please declare any conflict of interest here.}
%\equalauthors{\textsuperscript{1}A.O.(Author One) and A.T. (Author Two) contributed equally to this work (remove if not applicable).}
%\correspondingauthor{\textsuperscript{2}To whom correspondence should be addressed. E-mail: author.two\@email.com}

% Keywords are not mandatory, but authors are strongly encouraged to provide them. If provided, please include two to five keywords, separated by the pipe symbol, e.g:
\keywords{Collective behavior | Boids | Simulation | Prey-Predator | Escape patterns } 

\begin{abstract}
The collective behaviors observed in nature, such as flocking, herding, or schooling, often serve as adaptive strategies that enhance the survival chances of individuals within a group.
Understanding these natural behaviors serves as inspiration for designing autonomous agents capable of sophisticated interactions within a simulated environment.
Our goal is to simulate prey and predator with different predator tactics (attack center, attack nearest, attack isolated, attacks from various directions, constant bearing hunting), escape maneuvers (split, hourglass, herd, vacuole, flash expansion, fountain) and parameters (perception radius, moving speed, turning speed) in order to conclude how different escape maneuvers affect predator's success.

This research paper however, will only focus on the basic boid (bird-oid object) simulation.
This simulation will serve as a foundation for the more complex simulations in the future.
\nocite{papadopoulou2022emergence}
\end{abstract}

\dates{\textbf{\today}}
\program{BM-RI}
\vol{2023/24}
\no{CB:Group B} % group ID
%\fraca{FRIteza/201516.130}

\begin{document}

% Optional adjustment to line up main text (after abstract) of first page with line numbers, when using both lineno and twocolumn options.
% You should only change this length when you've finalised the article contents.
\verticaladjustment{-2pt}

\maketitle
\thispagestyle{firststyle}
\ifthenelse{\boolean{shortarticle}}{\ifthenelse{\boolean{singlecolumn}}{\abscontentformatted}{\abscontent}}{}

\section*{Introduction}

% If your first paragraph (i.e. with the \dropcap) contains a list environment (quote, quotation, theorem, definition, enumerate, itemize...), the line after the list may have some extra indentation. If this is the case, add \parshape=0 to the end of the list environment.
\dropcap{O}ne of the most striking patterns in biology is the formation of animal aggregations.
Classically, aggregation has been viewed as an evolutionarily advantageous state, in which members derive the benefits of protection, mate choice, and centralized information, balanced by the costs of limiting resources \cite{complexity_pattern}.
We would like to experimentally determine which flocking behaviors help the prey best defend itself against a predator.

The flocking behavior can be simulated in different ways.
For example, Heppner and Grenader \cite{Heppner_nonlinear_model} were modeling birds behavior with stochastic nonlinear differential equations.
Oweis, Ganesan, and Cheok \cite{centralized_flocking} took a different approach and modeled birds with a centralized logic (as in the server-client architecture).
In 1987, Reynolds \cite{reynolds1987flocks} proposed a simple algorithm, which was groundbreaking at the time, to model the
flocking behavior of birds, herding of sheep, and similar phenomena, known as the Boids (Bird-oid objects) model.
In contrast to controlling the interactions of the entire flock, the Boids simulation focuses on
dictating the behavior of each individual boid. Despite consisting of a few simple rules, this
algorithm produces complex and lifelike behaviors similar to those observed in nature.

Our research is based on a paper by Papadopoulou and others \cite{papadopoulou2022emergence}, which we will extend with the results of our predator and prey simulation.
Although we are not using fuzzy logic to set the direction and speed of our boids, which makes the movement less natural, we have taken some elements for our model from
\cite{JDemsar_predator_attacks}. Specifically, we've set the field of vision for our boids to 300° and implemented occlusion for the predator.

\section*{Methods}
A boids model is implemented, along with some additional checks to add more realism.
Boids model has 3 rules:
\begin{enumerate}
	\item Avoid collisions.
	      \begin{center}
		      \begin{tikzpicture}
			      % Draw a semi-transparent blue circle with a dark border
			      \draw[fill=blue!20, draw=blue!80] (0,0) circle (2);
			      % Define a triangle shape
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,green] (t1) at (0,0) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (t2) at (.5, 1) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (t3) at (-.75, .5) {};
			      % Outside,rotated
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, draw, rotate=30] (rotated) at (2.5,0) {};

			      \draw[green,thick] (t1) -- (t2);
			      \draw[green,thick] (t1) -- (t3);

			      \draw[red,thick,->] (t1) -- (-.125,-.75);
		      \end{tikzpicture}
	      \end{center}
	\item Maintain the same heading and speed as the neighboring boids.
	      \begin{center}
		      \begin{tikzpicture}
			      % Draw a semi-transparent blue circle with a dark border
			      \draw[fill=blue!20, draw=blue!80] (0,0) circle (2);
			      % Define a triangle shape
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,green,rotate=-30] (t1) at (0,0) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue,rotate=-30] (t2) at (-1.5, 0) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue,rotate=-30] (t3) at (1.5, 0) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue,rotate=-30] (t4) at (0, -1.5) {};

			      \draw[green,thick,->] (t1) -- ++(.5, 1);
			      \draw[black,thick,->] (t2) -- ++(.5, 1);
			      \draw[black,thick,->] (t3) -- ++(.5, 1);
			      \draw[black,thick,->] (t4) -- ++(.5, 1);
		      \end{tikzpicture}
	      \end{center}
	\item Gravitate toward the center of the flock.
	      \begin{center}
		      \begin{tikzpicture}
			      % Draw a semi-transparent blue circle with a dark border
			      \draw[fill=blue!20, draw=blue!80] (0,0) circle (2);
			      % Define a triangle shape
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (t1) at (0,0) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (t2) at (.5, 1) {};
			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (t3) at (-.75, .5) {};

			      \node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,green] (t4) at (1.2, -1.1) {};

			      \draw[green, thick] (t1) -- (-.125,.75);
			      \fill[green, thick] (-.125,.75) circle (2pt);
			      \draw[green,thick] (t2) -- (t3);

			      \draw[red,thick,->] (t4) -- (.75,-.3);
		      \end{tikzpicture}
	      \end{center}
\end{enumerate}

\subsection*{Boids implementation}

Each boid $B$ has the following properties:
\begin{enumerate}
	\item position - a vector in $ \mathbb{R}^2 $, denoted by $position(B)$,
	\item velocity - a vector in $ \mathbb{R}^2 $, denoted by $velocity(B)$,
	\item acceleration - a vector in $\mathbb{R}^2$; used exclusively
	      for the internal \\ computation of the boid's velocity and not for behavioral logic.
\end{enumerate}

\noindent With regards to behavioral logic, we also assign the following
attributes to all boids:
\begin{enumerate}
	\item perception radius (denoted by $r_P$)
	\item separation radius (denoted by $r_S$, also note that $ r_S < r_P $)
	\item perception angle (denoted by $fov$)
\end{enumerate}

\noindent The {\em Euclidean distance} (\ref{eq:eucl_dst}) is used for computing the distance between boids.
\begin{equation} \label{eq:eucl_dst}
	d(p, q) = \sqrt{(p_1-q_1)^2 + (p_2 - q_2)^2};\  p, q \in \mathbb{R}^2
\end{equation}
To avoid the computation of the costly square root of a real number, we utilize an equivalent formula
(\ref{eq:eucl_dst_sq}):
\begin{equation} \label{eq:eucl_dst_sq}
	d(p, q)^2 = (p_1-q_1)^2 + (p_2 - q_2)^2;\  p, q \in \mathbb{R}^2
\end{equation}

Each step of the simulation loop updates the direction of a boid, which is then applied to its acceleration,
determining the actual velocity for all boids.

Before applying the 3 mentioned rules, the neighbours of a boid.
Neighbours (\ref{eq:neighbor_predicate}) of boid $ B $ are all $B_i$ for which the following formula holds:

\begin{equation} \label{eq:neighbor_predicate}
	d(B, B_i)^2 < r_P^2 \land angle\ between(B, B_i) <= fov
\end{equation}

Taking perception angle ($fov$) into account adds more realism, especially when interacting with predators.

The direction for collision avoidance, also known as {\em separation}, for boid $B$ is computed by the
following formula (\ref{eq:sum_dir_vectors}):
\begin{equation} \label{eq:sum_dir_vectors}
	direction = \sum_{i=1}^{n} position(B) - position(B_i)
\end{equation}
where $i$-th boid $B_i$ is a neighbor of $B$ and: $ d(position(B), position(B_i))^2 < r_S^2 $.
This effectively means that boid $B$ will move away (in the opposite direction) from the boids which are too near (closer than the specified $r_S$).

The direction for {\em alignment} for boid $B$ is computed as (\ref{eq:sum_align}):
\begin{equation} \label{eq:sum_align}
	direction = \frac{\sum_{i=1}^{n} velocity(B_i)}{n} - velocity(B)
\end{equation}
where $i$-th boid $B_i$ is a boid such that: $ d(position(B), position(B_i)^2 < r_P^2) $ (i.e., $B_i$ is $B$'s neighbour).

The direction for {\em cohesion} for boid $B$ is computed like so (\ref{eq:sum_coh}):
\begin{equation} \label{eq:sum_coh}
	direction =  \frac{\sum_{i=1}^{n} \left(position(B_i) - position(B)\right)}{n}
\end{equation}

\subsection*{Occlusion algorithm}

In order to add more realism, the occlusion algorithm was implemented.
Because the algorithm is quite long with some edge cases, we will only explain the idea of the algorithm, which is quite simple.
Given a list of potential neighboring boids, we must determine which are occluded and in turn take only the nearest (non-occluded) boids as neighbours.
This is done by iterating through the list of neighboring boids (of boid $B$) and computing the angle between i-th ($B_i$) boid and all the others (in j-th step $B_j$).
If the angle difference is below a threshold, boids $B_i$ and $B_j$ are considered occluded.
To determine which boid occludes the other (is the actual neighbor), minimum distance is computed: $ min(d(B, B_i), d(B, B_j)) $.

\begin{center}
	\begin{tikzpicture}
		% Draw a semi-transparent blue circle with a dark border
		\draw[fill=blue!20, draw=blue!80] (0,0) circle (2);

		% Define a triangle shape for the top boid
		\node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,green] (boid1) at (0,1.5) {};

		% Define a triangle shape for the middle boid
		\node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,blue] (boid2) at (0,0) {};

		% Define a triangle shape for the bottom boid
		\node[regular polygon, regular polygon sides=3, minimum size=.5cm, fill,red] (boid3) at (0,-1.5) {};

		% Draw arrows indicating occlusion
		\draw[green,thick,<-] (boid2) -- (boid1);
		\draw[blue,thick,->] (boid2) -- (boid3);

		% Label for occlusion
		\node[blue, below] at (0, -0.5) {Occlusion};
	\end{tikzpicture}
\end{center}

\subsection*{Turn speed}

In order to add even more realism, the \textbf{turn speed} of a boid is limited.
Whenever the acceleration of a boid is computed, the angle between the acceleration vector and the current heading vector is checked.
If it exceedes a threshold, the old heading is rotated by the maximum amount in the given direction and scaled by the magnitude of the acceleration.
Therefore boids have a maximum value in which they can turn at each step of the simulation.

\subsection*{Escape maneuvers}

The 2 simplest escape maneuvers are implemented: escape based on position and based on velocity (direction) of the predator.

The position based escape maneuver works exactly the same way as separation, except the position of predator is taken into account.

The direction based escape maneuver works such that it determines on which side of prey lies the predator, and going into a perpendicular direction in the opposite side.

\subsection*{Predators}

2 simple predator behaviors (strategies) are implemented: attack centroid, attack random prey.

\section*{Results}

By combining all the features adding upon realism and the escape maneuvers, we can obtain a realstic patter \textbf{split}.
This pattern is obtain by using the \textbf{position} based escape manuever and any predator tactic.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\linewidth]{boids_step_146.jpg}
	\caption{Predator chasing a group of boids (step $146$)}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\linewidth]{boids_step_233.jpg}
	\caption{Start of split pattern (step $233$)}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\linewidth]{boids_step_261.jpg}
	\caption{Predator caught a prey, split continues (step $261$)}
\end{figure}


\pagebreak

\section*{Discussion}

This concludes boids implementation with additional realsitic features.
The simulation itself was heavily parameterized aswell, making tweakings easiser and more reproducible.

There is still room for improvement in the visualization of the simulation (add traces, add predators target, ...).

The most important aspect which remains is the implementation of different escape manuevers and predator tactics and the comparisons of the latter.

\acknow{Matija Ojo: Add realistic features, fix escape manuevers, report, Miha Krajnc: Escape manuevers, Janez Kuhar: report, Marko Adžaga: Researching sources and report}

\showacknow % Display the acknowledgments section

% \pnasbreak splits and balances the columns before the references.
% If you see unexpected formatting errors, try commenting out this line
% as it can run into problems with floats and footnotes on the final page.
%\pnasbreak

\begin{multicols}{2}
	\section*{\bibname}
	% Bibliography
	\bibliography{bibliography}
\end{multicols}

\end{document}